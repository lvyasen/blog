---
title: Redis 缓存问题
urlname: rbrcpf
date: '2022-05-07 12:05:59 +0800'
tags:
  - redis
categories:
  - Redis
---

### 什么是 redis 击穿?有哪些解决办法?

> 缓存穿透:指缓存和数据库中都没有数据,而用户不断发出请求,如发起的 id 为非法 id,这可能是攻击者

> 缓存击穿:与缓存雪崩有点像,但不一样,缓存雪崩是大面积缓存失效,落到 DB 上,缓存击穿指一个 key 非常热点,在不停的扛着大并发,大并发集中对一个点访问,当 key 在失效的瞬间穿破缓存直接请求数据库

#### 缓存穿透解决办法

1. 设置缓存时间永不过期
2. 加上互斥锁,第一个请求使用互斥锁锁住,其他线程拿不到锁就等着,等第一个线程查询到了数据然后就有缓存了,就直接走缓存

#### 缓存击穿解决办法

1. 在接口层增加校验,用户鉴权校验,参数校验不合法直接 return
2. 在缓存中取不到数据,在数据库中也取不到数据可以将对应的 key 设为 null 并提示用户稍后重试,缓存时间可以
3. nginx 配置限制所有单个 ip 访问频率,
   限制并发连接数 limit_conn_zone
   请求频率 limit_req_zone
4. redis 有个高级用法布隆过滤器(Bloon Filter)(,原理利用高效的数据结构和算法判断 key 是否存在数据库中,不存在直接 return 存在刷新缓存

```nginx
//限制 ip 访问频率
http {

    #$limit_conn_zone：限制并发连接数
    limit_conn_zone $binary_remote_addr zone=one1:10m;

    #limit_req_zone：请求频率
    #$binary_remote_addr：以客户端IP进行限制
    #zone=one:10m：创建IP存储区大小为10M,用来存储访问频率
    #rate=10r/s：表示客户端的访问评率为每秒10次
    limit_req_zone $binary_remote_addr zone=one2:10m   rate=10r/s;

}

```

##### 布隆过滤器

> 是由布隆 1970 年提出,是一种非常节省空间的概率数据结构,
> 运行速度快,占用内存小,不存储数据本身,仅存储 hash 取模运算的位标记,但有一定几率误判且无法删除元素
> 他是一个很长的二进制向量和一系列随机映射函数组成
> 主要用于判断一个元素是否在一个集合中

###### 布隆过滤器缺点

1. 不存储数据本身,所以只能添加不能删除,因为删除元素会导致误判率增加
2. 存在 hash 碰撞,匹配结果有一定误差
3. 当容量快满时,hash 碰撞几率增加,插入、查询错误率增加
4. 不支持计数,同一元素可多次插入,但和插入一次效果相同

布隆过滤器使用场景

1. 缓存击穿场景
2. 判断用户是否浏览过某一视频或文章
3. 网页爬虫对 URL 去重
4. Web 拦截器相同请求则拦截,防止重复被攻击

### 什么是 redis 雪崩?有哪些解决办法?

> 同一时间缓存的 key 全部失效,大量的请求全部落到数据库,数据扛不住压力

#### 解决办法

1. 存缓存数据的时候 key 加一个随机值,这样可以避免缓存在同一时间大面积失效
2. 如果 redis 是集群部署,将热点数据分布在不同的 redis 库中也能避免全部失效
3. 设置热点数据永不过期,定时任务更新缓存,这个方法最为保险
